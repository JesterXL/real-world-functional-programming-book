<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spot The Impurities</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/real-world-functional-programming-book/assets/css/0.styles.dda700b8.css" as="style"><link rel="preload" href="/real-world-functional-programming-book/assets/js/app.0715a213.js" as="script"><link rel="preload" href="/real-world-functional-programming-book/assets/js/2.6da8cf3d.js" as="script"><link rel="preload" href="/real-world-functional-programming-book/assets/js/15.62d54e5a.js" as="script"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/10.8e744d24.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/11.535cdb22.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/12.838cba83.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/13.8386adfa.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/14.25c778d2.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/16.8f2a7f1e.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/17.96c3770c.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/18.8649aee6.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/19.8e0a8ed3.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/20.5ad4bd07.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/21.7bc06d56.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/22.dd9d45d7.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/23.f2ad21f6.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/24.80f0959b.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/25.6e62b877.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/26.bec311ec.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/27.110f94a9.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/28.44066332.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/29.f824763d.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/3.51c6a686.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/30.bb7984c5.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/31.9b135bc8.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/32.4c26d247.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/33.5c022cb2.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/34.b4468fe6.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/35.a6519809.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/36.7dcb1e29.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/37.3980ad09.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/38.2eece47a.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/39.204af450.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/4.80637c28.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/40.4224b6ca.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/41.bc8d9404.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/42.e1e07aee.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/43.2d3e2472.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/44.f4445baf.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/45.b3d3ce23.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/46.bdf14109.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/47.cc2f20d7.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/48.7472b4b0.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/49.be902381.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/5.e3885fcf.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/50.da328e34.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/51.6c915d88.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/52.0200c5af.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/53.d3139ee5.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/54.59e84df1.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/55.22b3e22f.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/56.24c00eb1.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/57.d06026c6.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/58.e7f80591.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/59.903faa94.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/6.cd1d47c7.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/60.a621fdbb.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/61.bdab1198.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/62.3d1fa5b0.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/63.9ecd7d27.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/64.66141fb6.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/65.effed221.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/66.c2ec34a8.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/7.a98c49df.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/8.74213919.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/9.b819e594.js">
    <link rel="stylesheet" href="/real-world-functional-programming-book/assets/css/0.styles.dda700b8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/real-world-functional-programming-book/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/real-world-functional-programming-book/" class="sidebar-link">Introduction</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part1/" class="sidebar-heading clickable router-link-active open"><span>Part 1: Pure Functions</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/real-world-functional-programming-book/part1/input_output_side_effects.html" class="sidebar-link">Pure Functions: Same Input, Same Output, No Side Effects</a></li><li><a href="/real-world-functional-programming-book/part1/what_is_a_side_effect.html" class="sidebar-link">What is a Side Effect?</a></li><li><a href="/real-world-functional-programming-book/part1/var_and_let.html" class="sidebar-link">Et tu const?</a></li><li><a href="/real-world-functional-programming-book/part1/using_vs_enforcing_immutability.html" class="sidebar-link">Using vs Enforcing Immutability</a></li><li><a href="/real-world-functional-programming-book/part1/spot_the_impurities.html" class="active sidebar-link">Spot The Impurities</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part1/spot_the_impurities.html#prior-art" class="sidebar-link">Prior Art</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part1/spot_the_impurities.html#closures" class="sidebar-link">Closures</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part1/spot_the_impurities.html#http-call-fix" class="sidebar-link">HTTP Call Fix?</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part1/spot_the_impurities.html#random-noops" class="sidebar-link">Random Noops</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part1/spot_the_impurities.html#node-middlewares" class="sidebar-link">Node Middlewares</a></li></ul></li><li><a href="/real-world-functional-programming-book/part1/error_quest.html" class="sidebar-link">Hold Up, Wait a Minute, Let Us Trap The BOOM In It</a></li><li><a href="/real-world-functional-programming-book/part1/not_allowed.html" class="sidebar-link">The Specialist</a></li><li><a href="/real-world-functional-programming-book/part1/practice_purity.html" class="sidebar-link">Practice Purity Through Predicates</a></li><li><a href="/real-world-functional-programming-book/part1/practice_stubs.html" class="sidebar-link">Stubs</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part2/" class="sidebar-heading clickable"><span>Part 2: Getting and Setting Data</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part3/" class="sidebar-heading clickable"><span>Part 3: List Comprehensions</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part4/" class="sidebar-heading clickable"><span>Part 4: Basic Function Composition</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part5/" class="sidebar-heading clickable"><span>Part 5: Curry and Partial Applications</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part6/" class="sidebar-heading clickable"><span>Part 6: Algebraic Data Types</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part7/" class="sidebar-heading clickable"><span>Part 7: Optics</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part8/" class="sidebar-heading clickable"><span>Part 8: Debugging</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part9/" class="sidebar-heading clickable"><span>Part 9: Testing</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spot-the-impurities"><a href="#spot-the-impurities" class="header-anchor">#</a> Spot The Impurities</h1> <p>We're going to show a series of functions that are pure and impure. You'll see the various ways they break the pure function rules, and how to fix them. The strength of dynamic languages is that they have a wide variety of developers from different backgrounds such as Imperative, Object Oriented, and Declarative (Functional Programming).</p> <p>Declarative is in the minority.</p> <p>As such, you'll be navigating a lot of impure code and will have to decide what to make pure and what not too based on your experience, deadlines, and team norms. Knowing the nuanced ways one can break function purity will help you navigate non-pure code. You'll also start to develop a <a href="https://sixthsensereader.org/about-the-book/abcderium-index/spidey-sense/" target="_blank" rel="noopener noreferrer">Spidey Sense<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> about the signs of impurity, both in the code you read and in the code you write. As you develop this 6th sense, it'll help you on your journey to function purity and in code reviews of peers.</p> <h2 id="prior-art"><a href="#prior-art" class="header-anchor">#</a> Prior Art</h2> <p>But first, let's look at the various pure and impure functions built into JavaScript itself.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">1.034</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">1.034</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token number">1.034</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
</code></pre></div><p>Same input, same output. There is no side effects, either; you're just operating on the <code>Number</code> you passed in. Since the <code>Number</code> you passed is pass &quot;by val&quot;, it'll create a clone, so the output is a completely different <code>Number</code> then the one you passed in.</p> <p>However, even <code>Math</code> can be impure:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 0.9746597969597086</span>
Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 0.58324610344788</span>
Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 0.8089727088931593</span>
</code></pre></div><p>Same input, different output. Now cryptologists, those who work in software security, will tell you that technically <code>Math.random()</code> isn't random and thus deterministic. While true, the function still breaks function purity rules.</p> <p>Arrays, which are passed &quot;by ref&quot;, different variable pointing to the same data, also have their share of pure and impure functions.</p> <p>If we want to combine 2 Arrays together we can use <code>concat</code>:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> parents <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'Jesse'</span><span class="token punctuation">,</span> <span class="token string">'Brandy'</span> <span class="token punctuation">]</span>
<span class="token keyword">const</span> kids <span class="token operator">=</span> <span class="token punctuation">[</span> <span class="token string">'Sydney'</span><span class="token punctuation">,</span> <span class="token string">'Rowan'</span> <span class="token punctuation">]</span>
<span class="token keyword">const</span> family <span class="token operator">=</span> parents<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>kids<span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>family<span class="token punctuation">)</span> <span class="token comment">// [ 'Jesse', 'Brandy', 'Sydney', 'Rowan' ]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>parents<span class="token punctuation">)</span> <span class="token comment">// [ 'Jesse', 'Brandy' ]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>kids<span class="token punctuation">)</span> <span class="token comment">// [ 'Sydney', 'Rowan' ]</span>
</code></pre></div><p>The <code>concat</code> obeys same input, same output, and no side effects.</p> <p>However, <code>reverse</code> doesn't create a new Array, and instead mutates the original.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>parents<span class="token punctuation">)</span> <span class="token comment">// [ 'Jesse', 'Brandy' ]</span>
<span class="token keyword">const</span> reversed <span class="token operator">=</span> parents<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reversed<span class="token punctuation">)</span> <span class="token comment">// [ 'Brandy', 'Jesse' ]</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>parents<span class="token punctuation">)</span> <span class="token comment">// [ 'Brandy', 'Jesse' ]</span>
</code></pre></div><p>The <code>reverse</code> function obeys same input, same output, but it has side effects. The world changes after it runs because it doesn't utilize immutability.</p> <p>Libraries like <a href="https://ramdajs.com/docs/#reverse" target="_blank" rel="noopener noreferrer">Ramda<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> are built using pure functions. This makes it so you can use the same method names like Array's <code>reverse</code>, but not worry about side effects as all return values are immutable.</p> <h2 id="closures"><a href="#closures" class="header-anchor">#</a> Closures</h2> <p>Closures, whether Node or Browser, are a common way to utilize imported modules and classes.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> request <span class="token keyword">from</span> <span class="token string">'request-promise'</span>

<span class="token keyword">const</span> <span class="token function-variable function">getUsers</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/users/all'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>json<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This breaks the pure function rules in 2 ways: it's affected by the outside world, and it has side effects after it runs, whether the less pure CommonJS <code>require</code> or the more pure ES6 <code>import</code>. The <code>getUsers</code> won't always return the same output because the <code>request</code> doesn't come in from the function arguments. You'll also end up having to mutate your code using mocking/stubbing libraries like <a href="https://sinonjs.org/" target="_blank" rel="noopener noreferrer">Sinon<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> or <a href="https://github.com/testdouble/testdouble.js/" target="_blank" rel="noopener noreferrer">TestDouble<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> to test it. The side effects is from the <code>request.get</code> making an HTTP call.</p> <p><strong>Partial Solution</strong>: Declare your dependencies in your arguments.</p> <p>You make it pure by passing in the <code>request</code> module.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> request <span class="token keyword">from</span> <span class="token string">'request-promise'</span>

<span class="token keyword">const</span> <span class="token function-variable function">getUsers</span> <span class="token operator">=</span> <span class="token parameter">request</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/users/all'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>json<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>While you could turn your internet off, and the Promise that the <code>request</code> returns fails, the <code>getUsers</code> function is still returning a Promise every time from the same module. To unit test it, all you need is a simple stub:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> requestStub <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should return a Promise'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">getUsers</span><span class="token punctuation">(</span>requestStub<span class="token punctuation">)</span>
    <span class="token keyword">const</span> isAPromise <span class="token operator">=</span> <span class="token function">isPromise</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>isAPromise<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">equal</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// using chai-as-promised</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should resolve with a good stub'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getUsers</span><span class="token punctuation">(</span>requestStub<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span>be<span class="token punctuation">.</span>fulfilled
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should resolve with a user'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">getUsers</span><span class="token punctuation">(</span>requestStub<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">.</span><span class="token function">become</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="http-call-fix"><a href="#http-call-fix" class="header-anchor">#</a> HTTP Call Fix?</h2> <p>Fixing the HTTP call that is made, affecting the outside world after the function runs, is beyond the scope of this book. That level of purity is only gained through creating your own class/Object to contain those side effects, like <a href="http://elm-lang.org/" target="_blank" rel="noopener noreferrer">Elm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> does, or using strict state containers like <a href="https://redux.js.org/" target="_blank" rel="noopener noreferrer">Redux<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, <a href="https://github.com/calmm-js/documentation/blob/master/introduction-to-calmm.md" target="_blank" rel="noopener noreferrer">Calmm<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, or even more advanced methods such as <a href="https://reactjs.org/docs/hooks-intro.html" target="_blank" rel="noopener noreferrer">React Hooks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Many think it isn't worth it given it's such a common thing to do in browser applications and Node API's.</p> <p>In JavaScript, the simple solution is to return a <code>Promise</code>. It'll resolve when the operation is successful or not through <code>.then</code> and <code>.catch</code>. As long as the function you send to the <code>Promise</code> is a pure function, you're good &quot;enough&quot;.</p> <h2 id="random-noops"><a href="#random-noops" class="header-anchor">#</a> Random Noops</h2> <p>When you see functions that don't return values, you'll start to immediately identify them as noops. As long as they're logging related, you can often let them go. However, other times, they'll be in amongst other functions, not classes, and your hair should stand on end. Below is some Node.js code connecting to a Postegres database:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">getUsers</span> <span class="token operator">=</span> <span class="token parameter">pg</span> <span class="token operator">=&gt;</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">success<span class="token punctuation">,</span> failure</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> pool <span class="token operator">=</span> <span class="token function">getPool</span><span class="token punctuation">(</span>pg<span class="token punctuation">)</span>
        <span class="token function">connect</span><span class="token punctuation">(</span>pg<span class="token punctuation">)</span>
        pool<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">failure</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>The <code>getUsers</code> returns a Promise. She takes in the <code>pg</code> variable, probably a Postegres database module and thus declares her outside dependencies. The Promise wraps a callback, a side effect style way of coding, and using a Promise wrapper is a common way to make the function more pure. If it errors, it errors the Promise; if it succeeds, if gives the data parsed from the database query.</p> <p>... but what is <code>connect</code> doing? It has no return value. It does not appear like logging, and instead looks like it's attempting to connect to the Postegres database? What if it fails? What else is it doing? While we're inside a <code>Promise</code>, and thus have built-in try/catch functionality, this is actually worse in that it can hide it's side effect, and we wouldn't know until we inspect the <code>promise.catch</code> to read the error and figure out somewhere internally it's failing to connect.</p> <p>While not the best way to handle errors, the more pure way would be too have <code>connect</code> at a bare minimum return a <code>Promise</code>; it'll either connect, or it won't with an <code>Error</code> saying why. We can then connect that to our existing <code>Promise</code>, and only run the database query once it is successfully connected:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">getUsers</span> <span class="token operator">=</span> <span class="token parameter">pg</span> <span class="token operator">=&gt;</span>
    <span class="token function">connect</span><span class="token punctuation">(</span>pg<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">success<span class="token punctuation">,</span> failure</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> pool <span class="token operator">=</span> <span class="token function">getPool</span><span class="token punctuation">(</span>pg<span class="token punctuation">)</span>
            pool<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">failure</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token function">success</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
</code></pre></div><p>Be on the lookout for functions that have no return value and aren't logging related.</p> <h2 id="node-middlewares"><a href="#node-middlewares" class="header-anchor">#</a> Node Middlewares</h2> <p>Node was created and used long before <code>Promises</code> became du-jour in JavaScript. There are still many callback holdouts who swear by their <a href="https://github.com/caolan/async" target="_blank" rel="noopener noreferrer">async library<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. This means most of the popular API and site frameworks such as <a href="https://expressjs.com/" target="_blank" rel="noopener noreferrer">Express<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and <a href="http://restify.com/" target="_blank" rel="noopener noreferrer">Restify<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> all follow the Node middleware ways of architecting and building plugins. Middlewares hide massive side effects and are not pure.</p> <p>A basic API to get a list of users in Express looks like:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/users/list'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token function">getUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">users</span> <span class="token operator">=&gt;</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> result<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> users <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">{</span> result<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> error<span class="token punctuation">:</span> error<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div><p>However, that <code>http://localhost:9000/users/list</code> REST url would work without any authentication, so they'll have an authentication run first. The <code>app.get</code>'s function signature is &quot;First parameter is a String name of the route, every other parameter is a function you want to run&quot;.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
    <span class="token string">'/users/list'</span><span class="token punctuation">,</span> <span class="token comment">// route name</span>
    <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">...</span> <span class="token comment">// function to run when route is hit on server</span>
<span class="token punctuation">)</span>
</code></pre></div><p>It'll run them in order, so typically you'll see authentication plugins like OAuth ask you to put the authentication function first:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
    <span class="token string">'/users/list'</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">...</span><span class="token punctuation">,</span> <span class="token comment">// auth stuff here</span>
    <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">...</span>
<span class="token punctuation">)</span>
</code></pre></div><p>Notice the 3rd parameter called <code>next</code>. It's a function, specifically a callback function. When your function is done, it has 3 choices:</p> <ol><li>call <code>res.send</code>, preventing all further functions from being run.</li> <li>call <code>next()</code> with no parameters signalling your function or &quot;middleware&quot; is done and has run successfully, and the next middleware can run.</li> <li>call <code>next(error)</code> with an <code>Error</code> as the first and only parameter, signalling that your middleware failed and no further middlewares should be run.</li></ol> <p>What happens after depends on the framework and middleware, but typically you'd also send a message to the user.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
    <span class="token string">'/users/list'</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isAuthorizedUser</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">next</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Not authorized'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token operator">...</span>
<span class="token punctuation">)</span>
</code></pre></div><p>This mis-mash of patterns is what you'd to do compose asynchronous functions together in web/API frameworks before <code>Promise</code> chains became popular. The downside is there are a lot of side effects in this approach without any way for you to prevent them causing errors, nor easily unit test them without intentionally mocking side effects.</p> <p>The best way is just not use the middleware pattern at all, instead using Promises:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
    <span class="token string">'/users/list'</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token function">isAuthorized</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>user<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>getUsers<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">users</span> <span class="token operator">=&gt;</span>
            res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> result<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> users <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span>
            res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">{</span> result<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> error<span class="token punctuation">:</span> error<span class="token punctuation">.</span>message <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      
      <a href="/real-world-functional-programming-book/part1/using_vs_enforcing_immutability.html" class="prev">Using vs Enforcing Immutability</a></span> <span class="next"><a href="/real-world-functional-programming-book/part1/error_quest.html">Hold Up, Wait a Minute, Let Us Trap The BOOM In It</a>
      
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/real-world-functional-programming-book/assets/js/app.0715a213.js" defer></script><script src="/real-world-functional-programming-book/assets/js/2.6da8cf3d.js" defer></script><script src="/real-world-functional-programming-book/assets/js/15.62d54e5a.js" defer></script>
  </body>
</html>
