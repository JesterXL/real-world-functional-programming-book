<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Test Driven Development</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/real-world-functional-programming-book/assets/css/0.styles.dda700b8.css" as="style"><link rel="preload" href="/real-world-functional-programming-book/assets/js/app.4ecaf7cf.js" as="script"><link rel="preload" href="/real-world-functional-programming-book/assets/js/2.6da8cf3d.js" as="script"><link rel="preload" href="/real-world-functional-programming-book/assets/js/65.7d2bfbda.js" as="script"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/10.94dd7f8c.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/11.698c5c4f.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/12.192a3ae6.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/13.8386adfa.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/14.25c778d2.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/15.62d54e5a.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/16.8f2a7f1e.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/17.749ab795.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/18.ec23f3ec.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/19.9ba81683.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/20.70969485.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/21.7bc06d56.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/22.dd9d45d7.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/23.f2ad21f6.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/24.80f0959b.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/25.6e62b877.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/26.bec311ec.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/27.110f94a9.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/28.829fb020.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/29.f5b667c7.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/3.51c6a686.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/30.bb7984c5.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/31.9b135bc8.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/32.4c26d247.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/33.5c022cb2.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/34.b4468fe6.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/35.a6519809.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/36.7dcb1e29.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/37.3980ad09.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/38.2eece47a.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/39.204af450.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/4.80637c28.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/40.4224b6ca.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/41.47e1ccf5.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/42.ef4aaae1.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/43.927896fc.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/44.0e25a484.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/45.be50f1de.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/46.a6b52ac4.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/47.c9bcfbeb.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/48.9e11dca4.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/49.622efaaa.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/5.dd0514ea.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/50.07cb6d56.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/51.256e2d8e.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/52.a61ac66a.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/53.38837102.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/54.65632715.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/55.7558152f.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/56.632c19bc.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/57.44da2b00.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/58.5eeb983d.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/59.df5acc69.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/6.cd1d47c7.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/60.d35389d5.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/61.309602f9.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/62.0d8a9263.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/63.bc1b30ad.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/64.c2cc4933.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/66.c2ec34a8.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/7.603220b3.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/8.74213919.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/9.997a717b.js">
    <link rel="stylesheet" href="/real-world-functional-programming-book/assets/css/0.styles.dda700b8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/real-world-functional-programming-book/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/real-world-functional-programming-book/" class="sidebar-link">Introduction</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part1/" class="sidebar-heading clickable"><span>Part 1: Pure Functions</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part2/" class="sidebar-heading clickable"><span>Part 2: Getting and Setting Data</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part3/" class="sidebar-heading clickable"><span>Part 3: List Comprehensions</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part4/" class="sidebar-heading clickable"><span>Part 4: Basic Function Composition</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part5/" class="sidebar-heading clickable"><span>Part 5: Curry and Partial Applications</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part6/" class="sidebar-heading clickable"><span>Part 6: Algebraic Data Types</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part7/" class="sidebar-heading clickable"><span>Part 7: Optics</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part8/" class="sidebar-heading clickable"><span>Part 8: Debugging</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part9/" class="sidebar-heading clickable router-link-active open"><span>Part 9: Testing</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/real-world-functional-programming-book/part9/testing.html" class="active sidebar-link">Test Driven Development</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/testing.html#false-sense-of-security" class="sidebar-link">False Sense of Security</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/testing.html#what-is-a-public-api" class="sidebar-link">What is a Public API?</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/testing.html#tdd-internal-vs-feature" class="sidebar-link">TDD: Internal vs. Feature</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/testing.html#red-green-refactor" class="sidebar-link">Red, Green, Refactor</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/testing.html#step-1-failing-feature-unit-test" class="sidebar-link">Step 1: Failing Feature Unit Test</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/testing.html#step-2-write-your-fun-code" class="sidebar-link">Step 2: Write Your Fun Code</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/testing.html#step-3-refactor" class="sidebar-link">Step 3: Refactor</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/testing.html#red-green-refactor-conclusion" class="sidebar-link">Red, Green, Refactor Conclusion</a></li></ul></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/testing.html#api-example" class="sidebar-link">API Example</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/testing.html#step-1-red" class="sidebar-link">Step 1: Red</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/testing.html#step-2-green" class="sidebar-link">Step 2: Green</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/testing.html#step-3-refactor-2" class="sidebar-link">Step 3: Refactor</a></li></ul></li></ul></li><li><a href="/real-world-functional-programming-book/part9/stubs_and_mocks.html" class="sidebar-link">Only Stubs, No More Mocks or Spies</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="test-driven-development"><a href="#test-driven-development" class="header-anchor">#</a> Test Driven Development</h1> <p>[jwarden 3.10.2019] TODO: These code examples are massive... shrink 'em or break them out into sections. Also, why is this called testing, yet title is Test Driven Development?</p> <p><strong>Caveat</strong>: This section is not promoting Test Driven Development. It is not saying TDD is the one, true way to do things. It is not encouraging you to use TDD. Rather, it's a lens to show the truth of what Functional Programming will NOT solve for you, yet still containing helpful programming advice. That, and you should learn about TDD because multiple smart, experienced people agree it has goodness within despite the various, justified detractors.</p> <p>The Test Driven Development methodology gives uses unit testing as a way to design your code while ensuring you can be confident in constant feature additions and changes.</p> <p>However, the meaning of TDD over the years has warped into test everything first, and maintain this massive unit test suite full of complicated mocks and stubs, you can't play with ideas at all, or that your code is driven by tests. Once you start bringing in <a href="https://www.seleniumhq.org/" target="_blank" rel="noopener noreferrer">Selenium<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> / functional tests, things got worse.  The much respected David Heinemeier Hansson, known as <a href="https://twitter.com/dhh" target="_blank" rel="noopener noreferrer">DHH on Twitter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and famous for a variety of things namely creating <a href="https://rubyonrails.org/" target="_blank" rel="noopener noreferrer">Ruby on Rails<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, wrote a pretty <a href="http://david.heinemeierhansson.com/2014/tdd-is-dead-long-live-testing.html" target="_blank" rel="noopener noreferrer">scathing blog post on TDD<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> which further clouded the value.</p> <p>Let's assume for this post TDD is like Agile: Triggers a maligned attitude at its mere mention, is misunderstood, everyone says they practice it, apparently don't do it right, yet there is some truth is in there somewhere.</p> <p>Functional Programming, while making things easier to unit test, does NOT solve the problems of maintaining large unit test suites, helping you in consulting to convince teams to move from the <a href="https://martinfowler.com/articles/practical-test-pyramid.html" target="_blank" rel="noopener noreferrer">ice cream cone to the test pyramid<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> or hexagon/honeycomb/hardcore drugs, or ensuring your stubs accurately reflect the concretes they are substituting.</p> <p>Like Object Oriented Programming, it follows the same rules that Kent Beck and crew laid out to test the feature. We use the term feature instead of module because Node, Python, and Lua use the term module to imply &quot;where you put your function(s) and class(es)&quot;. Functional Programming like good Object Oriented code bases and bases in <a href="https://www.factorio.com/" target="_blank" rel="noopener noreferrer">Factorio<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, benefits from automating everything.</p> <p>Below will cover the false sense of security Functional Programming can give you, how Red Green Refactor is practiced in Functional Programming, and stating the obvious trade offs with using concrete implementations vs. stubs.</p> <h2 id="false-sense-of-security"><a href="#false-sense-of-security" class="header-anchor">#</a> False Sense of Security</h2> <p>Functional Programming can give you a few false senses of security:</p> <ul><li>Your test suite size WILL go down</li> <li>individual functions with few arguments are easier to test</li> <li>you'll get 100% test coverage more easily</li> <li>your tests are deterministic and pass consistently</li> <li>your larger test suites can be run concurrently, speeding them up and not breaking because there is no shared state in pure functions</li></ul> <p>While the suite size goes down, a lot of those tests may be testing implementation details and you don't need to test those. Like in OOP, publics test your privates. With 100% test coverage, you'll still get bugs. Stubs are not your concrete implementations; they are different. Consistently passing tests just mean they're consistently missing bugs or consistently having false positives. Functions with a lot of arguments, however, are still hard, have a lot of stubs, and can be just as confusing as large mocks.</p> <p>Bottom line, even if you no longer get new features, libraries update a lot for security reasons and innovation that changes the public API. You need to change your code even if your code isn't changing. Additionally, no one likes to maintain large test suites, even if they are more understandable in Functional code. This slows you and/or your team down. It's easier to delete the tests and start from scratch.</p> <p>To end on a happy note, it's a false sense of security, NOT accomplishment. The unit tests, high coverage, and few stubs are something you should be proud of. Just don't let it go to your head.</p> <h2 id="what-is-a-public-api"><a href="#what-is-a-public-api" class="header-anchor">#</a> What is a Public API?</h2> <p>When we talk about a public API from a Functional Programming perspective, we mean whatever functions are exposed from your module. Now, in Dynamic languages, there often isn't a lot of control here, nor a feature of public, private, nor protected, so you'll do one of the following:</p> <ol><li>expose everything</li> <li>expose everything, but name things with underscore prefixes (i.e. <code>thisIsPublic</code>, <code>_thisIsPrivate</code>)</li> <li>expose nothing and use closures only</li> <li>combination of the above using globals and a custom module system</li></ol> <p>What we mean by public API in JavaScript Node is whatever functions <code>module.exports</code> has on it, or whatever uses the <code>export</code> keyword in ES6. For Python, whatever your folder exposes via <code>__init__.py</code>. For Lua, whatever you return from your module file.</p> <p>Now, all 3 of those are modules, but they could import other modules and not expose those internals:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// string.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> startCase <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">parseName</span> <span class="token operator">=</span> <span class="token parameter">name</span> <span class="token operator">=&gt;</span> name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>startCase<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> parseName

<span class="token comment">// api.js</span>
<span class="token keyword">const</span> parseName <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./string'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> parseName
</code></pre></div><p>Our API in this case is the <code>parseName</code> function from the <code>api.js</code> file.</p> <p>If we import <code>parseName</code> from <code>api.js</code>, we can use it, but can't access anything else from it, nor from <code>string.js</code>. This controlled level of privacy allows api to only expose things it wants, and change the internals however it wants. This controlled flexibility is good: easier for the developers to get their ideas down in code and folders how they want, yet providing developers using it a consistent API. If the <code>api.js</code> were to change, they'd do a major version change in their <code>package.json</code> so code bases wouldn't break unless those developers are ready to change their code to accommodate the API change.</p> <p>The <code>parseName</code> is a function, but in OOP code bases, it'd be a <code>class</code>, and that class would have only <code>public</code> methods for you to utilize to access the internals however it sees fit. Both OOP and Functional Programming can practice encapsulation.</p> <h2 id="tdd-internal-vs-feature"><a href="#tdd-internal-vs-feature" class="header-anchor">#</a> TDD: Internal vs. Feature</h2> <p>TDD is pitched as &quot;write the test first, make it fail, then fix the code under test to make it pass&quot;. However, that leads to &quot;every function/class in my code base most likely has a test&quot;. For libraries especially, this may seem ok, but eventually you end up with massive amounts of unit tests usually outnumbering your code because of the stub and/or mock sizes. The problem here is soon as you want to change anything, even if you're not changing the public API, a lot of your tests break. So even if you don't change the public api, you're still having to maintain and modify all of those tests even if your feature doesn't break.</p> <p>... and that's what we care about: the feature.</p> <p>Both OOP and FP agree that they don't care about your implementation details, just the public API. However, the public API might not be your feature. You might not even know your public API yet.</p> <h2 id="red-green-refactor"><a href="#red-green-refactor" class="header-anchor">#</a> Red, Green, Refactor</h2> <p>The following describes how to practice Red, Green, Refactor for Functional Programming. Red Green Refactor is the core way of practicing Test Driven Development.</p> <h3 id="step-1-failing-feature-unit-test"><a href="#step-1-failing-feature-unit-test" class="header-anchor">#</a> Step 1: Failing Feature Unit Test</h3> <p>Take your feature, and write a unit test for it. Do the bare minimum to get it to compile and then ensure the test fails for the function not returning the right value. For the back-end this could be just 1 module that exports 1 method to &quot;do all the things&quot;. For front end, this could be unit test verifying you can do the basics in virtual DOM (it doesn't have to be Selenium based).</p> <h3 id="step-2-write-your-fun-code"><a href="#step-2-write-your-fun-code" class="header-anchor">#</a> Step 2: Write Your Fun Code</h3> <p>Write the code that will make the feature work. This should be right side brain fun. Don't stress about 100% function purity, nor worry getting your visual design pixel perfect to the design comps. Use real implementations of libraries instead of stubs/mocks. For front end, get the UI connected to the back-end. For the back-end, get it talking to the database or socket server and showing things in the browser or curl or <a href="https://www.getpostman.com/" target="_blank" rel="noopener noreferrer">Postman<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for REST URL's. This should make your feature test pass.</p> <p>No new tests should be added in this step.</p> <h3 id="step-3-refactor"><a href="#step-3-refactor" class="header-anchor">#</a> Step 3: Refactor</h3> <p>Make the code as pure as you deem appropriate and refactor until your happy. This should be the left brain fun.</p> <p>No new tests should be added in this step.</p> <h3 id="red-green-refactor-conclusion"><a href="#red-green-refactor-conclusion" class="header-anchor">#</a> Red, Green, Refactor Conclusion</h3> <p>The result should be a Red unit test, a Green test after your feature mostly works, and then code you're proud of without breaking the test nor by adding any new tests. When you add a new feature, repeat steps 1, 2, and 3. If you're using code coverage, you'll note that many paths aren't followed unless certain error conditions arise, and that's ok for now. We're interested in the happy path: does the feature work. Unhappy paths, such as login failure, are a feature as well so test those with the same guidelines.</p> <h2 id="api-example"><a href="#api-example" class="header-anchor">#</a> API Example</h2> <p>Let's do an API example first since it's easier than UI. We need to read a list of users from a relational database.</p> <blockquote><p>As a user,
I need to see a list of users,
so that I can better administrate my API&quot;. We'll use Node and Postegres.</p></blockquote> <h3 id="step-1-red"><a href="#step-1-red" class="header-anchor">#</a> Step 1: Red</h3> <p>Our basic app that currently does nothing but blow up:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">startServer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'startServer not implemented yet'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">stopServer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'stopServer not implemented yet'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    startServer<span class="token punctuation">,</span>
    stopServer
<span class="token punctuation">}</span>
</code></pre></div><p>And our <a href="https://jestjs.io/" target="_blank" rel="noopener noreferrer">Jest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> unit tests that fail:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> request <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token punctuation">{</span> startServer<span class="token punctuation">,</span> stopServer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../src/app'</span><span class="token punctuation">)</span>

<span class="token function">afterEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">stopServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">test</span><span class="token punctuation">(</span><span class="token string">'When I call the /users/list API, I should get a list of users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">startServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">success<span class="token punctuation">,</span> failure</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/users/list'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> res<span class="token punctuation">,</span> body</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                err
                <span class="token operator">?</span> <span class="token function">failure</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token punctuation">:</span> <span class="token function">success</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">users</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>users<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>firstName<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'jesse'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="step-2-green"><a href="#step-2-green" class="header-anchor">#</a> Step 2: Green</h3> <p>After setting up Postgres with a users table and inserting some data, I then write all the Node code to make it pass:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Pool <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pg'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/users/list'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> pool<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT username,date FROM users;'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> result<span class="token punctuation">.</span>rows<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">users</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>result<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> users<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>result<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> error<span class="token punctuation">:</span> err<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">let</span> server

<span class="token keyword">const</span> <span class="token function-variable function">startServer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span> <span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        server <span class="token operator">=</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">stopServer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    pool<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">success<span class="token punctuation">,</span> failure</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            server<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token function">failure</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    startServer<span class="token punctuation">,</span>
    stopServer
<span class="token punctuation">}</span>
</code></pre></div><p>Running <code>npm test</code> works and if I run coverage it's at 90%. To confirm why, we can see from the coverage report that the route and the stopping of the server both have error handling code that our happy path feature doesn't cover.</p> <h3 id="step-3-refactor-2"><a href="#step-3-refactor-2" class="header-anchor">#</a> Step 3: Refactor</h3> <p>Now we clean up the code. Let's make the functions mostly pure and add some minor database validation. We'll leave the <code>let</code> for now as our only state.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Pool <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'pg'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Result <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'folktale/result'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Ok <span class="token punctuation">}</span> <span class="token operator">=</span> Result
<span class="token keyword">const</span> Validation <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'folktale/validation'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> Success<span class="token punctuation">,</span> Failure <span class="token punctuation">}</span> <span class="token operator">=</span> Validation
<span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">,</span> partial<span class="token punctuation">,</span> memoize<span class="token punctuation">,</span> curry <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'lodash/fp'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">getPool</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> getPoolCached <span class="token operator">=</span> <span class="token function">memoize</span><span class="token punctuation">(</span>getPool<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">validRows</span> <span class="token operator">=</span> <span class="token parameter">o</span> <span class="token operator">=&gt;</span>
    Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>
    <span class="token operator">?</span> <span class="token function">Success</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>
    <span class="token punctuation">:</span> <span class="token function">Failure</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Invalid Rows: Postgres didn't return an Array of rows, instead returned: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>o<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">getUsers</span> <span class="token operator">=</span> <span class="token parameter">pool</span> <span class="token operator">=&gt;</span>
    pool<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT username,date FROM users;'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'rows'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>validRows<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">validation</span> <span class="token operator">=&gt;</span>
        validation<span class="token punctuation">.</span><span class="token function">matchWith</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
           <span class="token function-variable function">Failure</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Result<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token function-variable function">Success</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Ok</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
        Result<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Postgres Error: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> getUsersPartial <span class="token operator">=</span> <span class="token function">partial</span><span class="token punctuation">(</span>getUsers<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">getPoolCached</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">sendError</span> <span class="token operator">=</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> result<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> error <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">sendOk</span> <span class="token operator">=</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> result<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> getUsersRoute <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token parameter">getUsersPartial<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token function">getUsersPartial</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span>
        result<span class="token punctuation">.</span><span class="token function">matchWith</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token function-variable function">Error</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">sendError</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function-variable function">Ok</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">sendOk</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> getUsersRoutePartial <span class="token operator">=</span> <span class="token function">getUsersRoute</span><span class="token punctuation">(</span>getUsersPartial<span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">addUsersListRoute</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token parameter">route</span> <span class="token operator">=&gt;</span>
    <span class="token function">Ok</span><span class="token punctuation">(</span>
        app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/users/list'</span><span class="token punctuation">,</span> route<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">listen</span> <span class="token operator">=</span> <span class="token parameter">port</span> <span class="token operator">=&gt;</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span>
    Result<span class="token punctuation">.</span><span class="token function">try</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>

<span class="token keyword">let</span> server
<span class="token keyword">const</span> <span class="token function-variable function">startServer</span> <span class="token operator">=</span> <span class="token parameter">getUsersRoutePartial</span> <span class="token operator">=&gt;</span> <span class="token parameter">port</span> <span class="token operator">=&gt;</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span>
    <span class="token function">addUsersListRoute</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">(</span>getUsersRoutePartial<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token parameter">_</span> <span class="token operator">=&gt;</span> <span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token parameter">newServer</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        server <span class="token operator">=</span> newServer
        <span class="token keyword">return</span> Result<span class="token punctuation">.</span><span class="token function">Ok</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">matchWith</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token function-variable function">Error</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function-variable function">Ok</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>value<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">startServerPartial</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">startServer</span><span class="token punctuation">(</span>getUsersRoutePartial<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">stopServer</span> <span class="token operator">=</span> <span class="token parameter">pool</span> <span class="token operator">=&gt;</span>
    pool<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span> <span class="token parameter">_</span> <span class="token operator">=&gt;</span> server<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> stopServerPartial <span class="token operator">=</span> <span class="token function">partial</span><span class="token punctuation">(</span>stopServer<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">getPoolCached</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    startServer<span class="token punctuation">:</span> startServerPartial<span class="token punctuation">,</span>
    stopServer<span class="token punctuation">:</span> stopServerPartial
<span class="token punctuation">}</span>
</code></pre></div><p>Coverage goes from 90% to 88% because we are not covering the 2 new error scenarios it introduced. Coverage is still helping, though, because it's pointing out areas we can do some more testing on later.</p> <p>The point is, more pure code, easier to test specific parts if you need, API didn't change, and we didn't violate the rules by adding any new tests. Feature still works despite the fact we completely rewrote the internals to be more functional.</p> <h1 id="property-tests"><a href="#property-tests" class="header-anchor">#</a> Property Tests</h1> <p>Property tests are unit tests that generate random data. Even if you have greater than 100% unit test coverage, you can miss a certain scenarios:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">stringNotBlank</span> <span class="token operator">=</span> <span class="token parameter">o</span> <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token string">''</span>

<span class="token function">stringNotBlank</span><span class="token punctuation">(</span><span class="token string">'cow'</span><span class="token punctuation">)</span> <span class="token comment">// true</span>
<span class="token function">stringNotBlank</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span> <span class="token comment">// false</span>
<span class="token function">stringNotBlank</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// TypeError: Cannot read property 'length' of undefined</span>
</code></pre></div><p>To fix, you have to change it to:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> isString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'lodash'</span>

<span class="token keyword">const</span> <span class="token function-variable function">stringNotBlank</span> <span class="token operator">=</span> <span class="token parameter">o</span> <span class="token operator">=&gt;</span> <span class="token function">isString</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> o<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token string">''</span>
</code></pre></div><p>Instead of trying to ensure you've covered every possible input type, you instead let the computer generate those for you. Also called fuzz tests, they are inspired by <a href="http://hackage.haskell.org/package/QuickCheck" target="_blank" rel="noopener noreferrer">Quickcheck<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> from Haskell.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      
      <a href="/real-world-functional-programming-book/part8/log_purity.html" class="prev">Log Purity</a></span> <span class="next"><a href="/real-world-functional-programming-book/part9/stubs_and_mocks.html">Only Stubs, No More Mocks or Spies</a>
      
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/real-world-functional-programming-book/assets/js/app.4ecaf7cf.js" defer></script><script src="/real-world-functional-programming-book/assets/js/2.6da8cf3d.js" defer></script><script src="/real-world-functional-programming-book/assets/js/65.7d2bfbda.js" defer></script>
  </body>
</html>
