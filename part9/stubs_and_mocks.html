<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Only Stubs, No More Mocks or Spies</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/real-world-functional-programming-book/assets/css/0.styles.dda700b8.css" as="style"><link rel="preload" href="/real-world-functional-programming-book/assets/js/app.ad1bfc28.js" as="script"><link rel="preload" href="/real-world-functional-programming-book/assets/js/2.774c5d42.js" as="script"><link rel="preload" href="/real-world-functional-programming-book/assets/js/58.5dd45008.js" as="script"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/10.94dd7f8c.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/11.698c5c4f.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/12.192a3ae6.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/13.8386adfa.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/14.25c778d2.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/15.22df2363.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/16.8f2a7f1e.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/17.96c3770c.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/18.53fa9806.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/19.ddf2a677.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/20.010d7881.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/21.d4385542.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/22.63c29633.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/23.0b95ec99.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/24.030da7fd.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/25.6075c853.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/26.6e33666c.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/27.52ebbb9a.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/28.480e5398.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/29.44aa6890.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/3.ce6d7c8e.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/30.36ffc316.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/31.3e451e47.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/32.03e0d851.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/33.15f7a19e.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/34.1962de40.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/35.9a9c5557.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/36.649f4a76.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/37.360dc873.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/38.4369e41d.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/39.7b6c045d.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/4.80637c28.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/40.929f8cf3.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/41.5630fa3d.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/42.5eed66fd.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/43.66d1dc46.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/44.b329c0c4.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/45.c2ff687a.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/46.70dbd72b.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/47.e725e0a3.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/48.7b884d6a.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/49.f3176d54.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/5.f3fe2246.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/50.1f0d0491.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/51.505f0293.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/52.cec6ae98.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/53.f676af80.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/54.90c93f46.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/55.12ba710b.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/56.c95224bc.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/57.15f55d22.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/59.67287c0b.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/6.26e4ee07.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/60.60191211.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/7.a98c49df.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/8.74213919.js"><link rel="prefetch" href="/real-world-functional-programming-book/assets/js/9.997a717b.js">
    <link rel="stylesheet" href="/real-world-functional-programming-book/assets/css/0.styles.dda700b8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/real-world-functional-programming-book/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/real-world-functional-programming-book/" class="sidebar-link">Inroduction</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part1/" class="sidebar-heading clickable"><span>Part 1: Pure Functions</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part2/" class="sidebar-heading clickable"><span>Part 2: Getting and Setting Data</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part3/" class="sidebar-heading clickable"><span>Part 3: List Comprehensions</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part4/" class="sidebar-heading clickable"><span>Part 4: Curry and Partial Applications</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part5/" class="sidebar-heading clickable"><span>Part 5: Composition</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part6/" class="sidebar-heading clickable"><span>Part 6: Algebraic Data Types</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part7/" class="sidebar-heading clickable"><span>Part 7: Optics</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part8/" class="sidebar-heading clickable"><span>Part 8: Debugging</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/real-world-functional-programming-book/part9/" class="sidebar-heading clickable router-link-active open"><span>Part 9: Testing</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/real-world-functional-programming-book/part9/testing.html" class="sidebar-link">Test Driven Development</a></li><li><a href="/real-world-functional-programming-book/part9/stubs_and_mocks.html" class="active sidebar-link">Only Stubs, No More Mocks or Spies</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/stubs_and_mocks.html#unit-test" class="sidebar-link">Unit Test</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/stubs_and_mocks.html#object-under-test" class="sidebar-link">Object Under Test</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/stubs_and_mocks.html#what-is-a-stub" class="sidebar-link">What is a Stub?</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/stubs_and_mocks.html#what-is-a-mock" class="sidebar-link">What is a Mock?</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/stubs_and_mocks.html#mocks-in-post-assertions" class="sidebar-link">Mocks in Post Assertions</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/stubs_and_mocks.html#call-something-here-read-about-it-over-there" class="sidebar-link">Call Something Here, Read About It Over There</a></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/stubs_and_mocks.html#pre-programmed-assertions" class="sidebar-link">Pre-programmed Assertions</a></li></ul></li><li class="sidebar-sub-header"><a href="/real-world-functional-programming-book/part9/stubs_and_mocks.html#conclusions" class="sidebar-link">Conclusions</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="only-stubs-no-more-mocks-or-spies"><a href="#only-stubs-no-more-mocks-or-spies" class="header-anchor">#</a> Only Stubs, No More Mocks or Spies</h1> <p>[jwarden 3.10.2019] TODO/FIXME: I think this chapter started out good, but needs a redo. There's some good content in here, but it's easier to show WHY FP doesn't need mocks vs. stubs without resorting to a lesson what all these things are in excruciatingly detail.</p> <p>You don't need mocks in Functional Programming because mocks test side effects. If you're writing Functional code, it is made up of pure functions. Pure functions don't have side effects. So no need for mocks. If you're trying to isolate code, you may still need stubs.</p> <p>However, in the real world, you may be working with non-FP code, so you'll still need Mocks to test for side effects.</p> <p>Let's get some nomenclature down first.</p> <h2 id="unit-test"><a href="#unit-test" class="header-anchor">#</a> Unit Test</h2> <p>A unit test is supposed to be a unit. No one knows (but think they know) what a unit is in programming. For now, a unit is any Object you want to test: Object, class, function, module, whatever.</p> <h2 id="object-under-test"><a href="#object-under-test" class="header-anchor">#</a> Object Under Test</h2> <p>An &quot;object under test&quot; is the thing you're testing. If you have an <code>it</code> in <a href="https://jestjs.io/" target="_blank" rel="noopener noreferrer">Jest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>/<a href="https://jasmine.github.io/" target="_blank" rel="noopener noreferrer">Jasmine<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>/<a href="https://mochajs.org/" target="_blank" rel="noopener noreferrer">Mocha<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> in JavaScript or <a href="https://olivinelabs.com/busted/" target="_blank" rel="noopener noreferrer">Busted<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> in Lua, or a <code>test_*</code> function Python's <a href="https://docs.pytest.org/en/latest/" target="_blank" rel="noopener noreferrer">PyTest<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, whatever that test function is supposed to be testing, that's the &quot;object under test&quot;. Given how Mocks/Spies work, however, it may not be immediately obvious &quot;what is the actual object under test here?&quot;</p> <h2 id="what-is-a-stub"><a href="#what-is-a-stub" class="header-anchor">#</a> What is a Stub?</h2> <p>A stub is typically an <code>Object</code> or <code>Function</code> that always does the same thing, typically returning the hardcoded value you need. If you want your unit tests to be deterministic, and thus dependable, you ensure they always do the same thing every time they run. Given our <code>loadWebsite</code> function:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">loadWebsite</span> <span class="token operator">=</span> <span class="token parameter">request</span> <span class="token operator">=&gt;</span> <span class="token parameter">url</span> <span class="token operator">=&gt;</span> <span class="token operator">...</span>
</code></pre></div><p>If we want to stub <code>request</code> to guarantee the test works whether the internet works or not with minimal/no side effects, you stub it:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> requestStub <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">get</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'hey'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This stub is mostly a pure function, and we can use it to create a dependable unit test:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'loadWebsite should work'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">loadWebsite</span><span class="token punctuation">(</span>requestStub<span class="token punctuation">,</span> <span class="token string">'some url'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'hey'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="what-is-a-mock"><a href="#what-is-a-mock" class="header-anchor">#</a> What is a Mock?</h2> <p>Mocks are stubs that can track what happened to them during the test execution. You can then make assertions on what they remember. They are sometimes called spies because the Object will record what it sees &quot;covertly&quot;. Whether using Object Oriented Programming or Functional, the &quot;how things happen&quot; is intended to be hidden, so using an Object in this way is considered spying. In Dynamic languages, they'll sometimes re-use a real implementation, and overwrite functions, methods, or properties with temporary Objects unlike statically typed languages where it's wrapped through Composition. This may cause a <code>restore</code> step, where you turn the Object back to the way it was after the test/suite.</p> <p>Let's cover post assertions, testing specifically for side effects, and pre-assertions.</p> <h2 id="mocks-in-post-assertions"><a href="#mocks-in-post-assertions" class="header-anchor">#</a> Mocks in Post Assertions</h2> <p>Given our old school <code>for</code> loop:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">getParsedNames</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">names<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> names<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> parsedName <span class="token operator">=</span> <span class="token function">parseName</span><span class="token punctuation">(</span>names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>parsedName<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We can test what happened to the callback; did it get inside the function and get used like we think it should? To do that, we need a function that remembers what happened to itself.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">mockCallback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    mockCallback<span class="token punctuation">.</span>calls<span class="token operator">++</span>
    mockCallback<span class="token punctuation">.</span>calledWith<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
mockCallback<span class="token punctuation">.</span>calls <span class="token operator">=</span> <span class="token number">0</span>
mockCallback<span class="token punctuation">.</span>calledWith <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
</code></pre></div><p>Not when we test it, we can make some assertions on it in the test:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'getParsedNames should be called with correct parsed names 3 times for 3 item array'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'jesse warden'</span><span class="token punctuation">,</span> <span class="token string">'brandy fortune'</span><span class="token punctuation">,</span> <span class="token string">'albus dumbledog'</span><span class="token punctuation">]</span>
    <span class="token function">getParsedNames</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> mockCallback<span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>mockCallback<span class="token punctuation">.</span>calls<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>mockCallback<span class="token punctuation">.</span>calledWith<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token string">'Fortune, Brandy'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="call-something-here-read-about-it-over-there"><a href="#call-something-here-read-about-it-over-there" class="header-anchor">#</a> Call Something Here, Read About It Over There</h3> <p>Pure function rules are same input, same output, and no side effects. Class methods typically are not pure functions because although they sometimes may have inputs, many don't have return values, and almost always are setting data internally on a mutable <code>this</code> or <code>self</code> property that is the place where all the data internally for the class is stored. While you can write pure functions in a class, and even make them public, if you're using a class, you're going to follow the Object Oriented Programming rule of encapsulation. That is hiding data internally, and exposing access to it from a public API.</p> <p>In a sense, one could argue that a class can be a pure function because it can follow the spirit of the pure function rules:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Adder</span> <span class="token punctuation">{</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_result <span class="token operator">=</span> a <span class="token operator">+</span> b
    <span class="token punctuation">}</span>
    <span class="token keyword">get</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>result
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Adder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
a<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;result:&quot;</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>result<span class="token punctuation">)</span>
</code></pre></div><p>However, as soon as you test it, you know you're testing side effects because there:</p> <ul><li>is no return value</li> <li>the value changes on the object after you set a method</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;Adder's add, when called will add 2 numbers&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Adder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Let's read those expectations in order:</p> <ol><li>Make sure the Object's result property is <code>undefined</code></li> <li>Make sure the method has a side effect on the Object.</li> <li>Make sure the method didn't return a result.</li></ol> <p>Let's re-write that as a pure function with test:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">+</span> b

<span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'add will add 2 numbers'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Has a return value, no need to check before and after for side effects. You'll do this a lot in UI frameworks where you're trying to see &quot;if the UI updated after I set data&quot;.</p> <h3 id="pre-programmed-assertions"><a href="#pre-programmed-assertions" class="header-anchor">#</a> Pre-programmed Assertions</h3> <p>[jwarden 3.10.2019] TODO/FIXME: TypeScript is unnecessary here and the examples are verbose. I know mocks are verbose, but try harder.</p> <p>Traditionally, mocks are known for pre-programmed assertions. You use them in this way to ensure things are being used as expected... if not, fail the test. Instead of testing how something was used, like a spy, you make your assertions before you even call your object under test. Let's OOP-i-fy our names parser using <a href="https://www.typescriptlang.org/docs/handbook/classes.html" target="_blank" rel="noopener noreferrer">TypeScript<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> so we can enforce public/private properties and methods:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> startCase <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'lodash'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">NamesParser</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> names<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>
    <span class="token keyword">private</span> _parsedNames<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>

    <span class="token keyword">public</span> <span class="token keyword">get</span> <span class="token function">parsedNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_parsedNames
    <span class="token punctuation">}</span>

    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">names<span class="token punctuation">:</span> Array<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>names <span class="token operator">=</span> names
        <span class="token keyword">this</span><span class="token punctuation">.</span>_parsedNames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token function">parseName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token punctuation">:</span> String <span class="token punctuation">{</span>
        <span class="token keyword">return</span> name<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>startCase<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">', '</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">parseNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_parsedNames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>names<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_parsedNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">parseName</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>For the unit test, we know it should return a good value, so let's build that assertion into the mock. This one will pass because <code>parseName</code> is only being called once for the 1 item in the Array:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'NamesParser should call parseName one time for 1 value'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamesParser</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'jesse warden'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> mock <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span>
    mock<span class="token punctuation">.</span><span class="token function">expects</span><span class="token punctuation">(</span><span class="token string">&quot;parseName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">throws</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span><span class="token function">parseNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    mock<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>This one fails because we gave it 2 items, but keep the expectation that will will call <code>parseName</code> 1 time:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'NamesParser should call parseName one time for 1 value'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> parser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NamesParser</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'jesse warden'</span><span class="token punctuation">,</span> <span class="token string">'brandy fortune'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> mock <span class="token operator">=</span> sinon<span class="token punctuation">.</span><span class="token function">mock</span><span class="token punctuation">(</span>parser<span class="token punctuation">)</span>
    mock<span class="token punctuation">.</span><span class="token function">expects</span><span class="token punctuation">(</span><span class="token string">&quot;parseName&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">once</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">throws</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span><span class="token function">parseNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    mock<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Again, test one thing here, but look for the results over there. With Mocks via pre-programmed assertions, you've doing 4 nasty things:</p> <ol><li>mutating the object under test</li> <li>creating and testing specifically for side effects</li> <li>intentionally throwing an <code>Error</code></li> <li>re-mutate the object after the test</li></ol> <p>While 1 and 4 do not follow pure function rules, you get a pass since you're in a dynamic language, and that's one of the reasons we like dynamic languages; everything is fair game and it's how most mocking libraries are built. That said, your unit tests are not your actual code anymore; they're modified objects. Number 3, while intentional in unit tests, is not following pure function rules. You give a function inputs and test its outputs. An <code>Error</code> is not an output, it's a side effect. Again, you get a pass because technically it's the mock throwing the error, not your function/class.</p> <p>... however, #2 is not ok at all.</p> <h2 id="conclusions"><a href="#conclusions" class="header-anchor">#</a> Conclusions</h2> <p>As you can see, there is zero need for spies/mocks with pure functions because:</p> <ol><li>no need to mutate the object before or after; it's a <code>function</code> and you use as is</li> <li>no need to setup assertions on how something should be used, you're just calling 1 function and checking the outputs are expected based on the inputs</li> <li>Side effects?</li></ol> <p>You'll assume no side effects, yes, HOWEVER, don't discount testing for them. Using unit tests to test for the LACK OF side effects is actually something unit tests are really good at. If you're not sure if code is 100% pure, unit tests will help you track them down. Just be aware these tests will rot over time, especially if you are testing private module methods. Feel free to delete later vs. maintain them.</p> <p>Mocks aren't used in Functional Programming because there are no side effects to test for. The Object under test is always a <code>function</code>, so there is no <code>class</code> method or <code>Object</code> property to modify and watch. You're just testing the functions that take inputs and have expected outputs. Some of those inputs may be slow, complicated, or from hard to setup 3rd party code so pure function stubs may be used.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ‚Üê
      <a href="/real-world-functional-programming-book/part9/testing.html" class="prev">Test Driven Development</a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/real-world-functional-programming-book/assets/js/app.ad1bfc28.js" defer></script><script src="/real-world-functional-programming-book/assets/js/2.774c5d42.js" defer></script><script src="/real-world-functional-programming-book/assets/js/58.5dd45008.js" defer></script>
  </body>
</html>
